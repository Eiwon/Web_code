<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>영화관 좌석 예매</title>
<script src="https://code.jquery.com/jquery-3.7.1.slim.js"></script>
<style type="text/css">
.selected_btn{
	background-color: red;
}
.unselected_btn{
	background-color: lightgrey;
}
.short{
	width: 500px;
	height: 200px;
}
.boardMid{
	border: 1px solid black;
	width: 800px;
	height: 200px;
}
.boardLarge{
	border: 1px solid black;
	width: 1600px; 
	height: 280px;
}
#btnNext{
	width: 100px;
	height: 100px;
}
</style>

</head>
<body>
	<h1 style="text-align: center;">영화관 좌석 예매</h1>
	<div>
		<div style="display: flex; border: 1px solid black;">
			<p style="text-align: center; width: 1900px">인원 / 좌석</p><button id="btnReset">초기화</button>
		</div>
		<div style="display: flex;">
			<div id="guestInfo" class="boardMid">
			</div>
			<div id="movieInfo" class="boardMid">
				<strong class="cinemaName"></strong>
				<strong class="cinemaNumber"></strong>
				<strong>남은 좌석 : <strong id="remainSeat"></strong> / <strong id="maxSeat"></strong></strong>
			</div>
		</div>
		<div class="boardLarge" style="text-align: center">
			<div id="seatInfo" style="display: inline-block;"></div>
		</div>
		<div class="boardLarge" style= "display: flex;">
			<div id="cinemaShort" class="short">
				<div>극장 : <strong class="cinemaName"></strong></div>
				<div>상영관 : <strong class="cinemaNumber"></strong></div>
			</div>
			<div id="seatShort" class="short">
				<div>좌석명 : <strong>일반석</strong></div>
				<div>좌석번호 : <strong id="selected_seat_num"></strong></div>
			</div>
			<div id="guestShort" class="short"></div>
			<input type="button" id="btnNext" value="결제">
		</div>
	</div>
	
	<script type="text/javascript">
	
		// 상수값 정의
		const guestType = ['일반','청소년','경로','우대'];
		const priceType = [15000, 12000, 7000, 5000];
		let priceMap = [];
		for(x in guestType){
			priceMap[guestType[x]] = priceType[x];
		}
		const cinemaName = 'CGV 동대문';
		const cinemaNumber = '3관 10층';
		const maxGuestNum = 8;
		const seatState = ['none', 'enable', 'selected', 'reserved', 'banned'];
		let seatMap = [
			[1, 1, 1, 1, 0, 0, 1, 1, 4, 4],
			[1, 1, 1, 1, 0, 0, 1, 1, 1, 1],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[1, 1, 1, 3, 3, 3, 3, 1, 1, 1],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
			[1, 1, 1, 1, 0, 0, 1, 1, 1, 1]
			];
		
		let selectedGuestNum;
		let selectedSeatNum;
		let guestNum = [];
		let maxSeatNum;
		let enableSeatNum;
		
		let guestInfo = $('#guestInfo');
		let seatInfo = $('#seatInfo');
		let seatShort = $('#selected_seat_num');
		let guestShort = $('#guestShort');
		let btnNext = $('#btnNext');
		
		initTicket();
		
		$(document).ready(function(){
			initGuestNumBtn();
			initSeat();
			
			function initGuestNumBtn(){
				console.log('initGuestNumBtn');
				for(let i = 0; i < guestType.length; i++){
					let guestRow = $('<div class="guestRow"></div>');
					guestRow.text(guestType[i]);
					for(let num = 0; num <= maxGuestNum; num++){
						let btnGuestNum = $('<input type="button" class="btnGuestNum">');
						btnGuestNum.val(num);
						
						btnGuestNum.click(function(){
							console.log('btnGuestNum click');
							// 클릭한 열의 타입명을 가져와서 guestNum 변경
							let type = this.parentElement.innerText;
							let num = parseInt(this.value);
							if(limitCheck(type, num)){
								console.log('limit available');
								guestNum[type] = num;
								selectedGuestNum = 0;
								for(x in guestNum){
									selectedGuestNum += guestNum[x];
								}
								console.log('총 예매인원 : ' + selectedGuestNum + '명');
								repaintBtn();
								refreshGuestShort();
								chargeCheck();
							}
						}); // end btnGuestNum click
						guestRow.append(btnGuestNum);
					}
					guestInfo.append(guestRow);
				} 
			}// end initGuestNumBtn
			
			function initSeat(){
				console.log('initSeat');
				for(x in seatMap){
					let row = $('<div></div>');
					row.text(x);
					for(y in seatMap[x]){
						let seat = seatState[seatMap[x][y]];
						let seatElement = $('<input type="button">');
						if(seat == 'enable'){
							seatElement.attr('disabled', false);
							seatElement.val(y);
							seatElement.addClass('unselected_btn');
						
							seatElement.mouseover(function(){
								if(this.classList.contains('unselected_btn')){
									this.style.backgroundColor = 'red';
								}
							});
							seatElement.mouseout(function(){
								if(this.classList.contains('unselected_btn')){
									this.style.backgroundColor = 'lightgrey';
								}	
							});
							seatElement.click(function(){
								let btnRow = parseInt(this.parentElement.innerText);
								let btnCol = parseInt(this.value);
								console.log('좌석 좌표 : ' + btnRow + ', ' + btnCol);
							
								// 1. 선택 안한 좌석일 경우
								if(this.classList.contains('unselected_btn')){
									if(selectedSeatNum < selectedGuestNum){
										seatMap[btnRow][btnCol] = 2;
										selectedSeatNum++;
										console.log("선택된 좌석 수 : " + selectedSeatNum);
									}else{ // 선택 한도 초과
										alert('이미 좌석을 모두 선택하였습니다.');
										return;
									}
								}else{// 2. 이미 선택한 좌석일 경우 == 선택 취소
									seatMap[btnRow][btnCol] = 1;
									selectedSeatNum--;
									console.log("선택된 좌석 수 : " + selectedSeatNum);
								}
							
								this.classList.toggle('unselected_btn');
								this.classList.toggle('selected_btn');
							
								// seatShort 좌석번호 최신화
								refreshSeatShort();
								// guestShort 요금 최신화
								refreshGuestShort();
								chargeCheck();
							});
						}else if(seat == 'none'){ // 사용불가 좌석
							seatElement.css('visibility', 'hidden');
						}else if(seat == 'reserved'){ // 예약된 좌석
							seatElement.css('background-color', 'orange');
							seatElement.attr('disabled', true);
							seatElement.val(y);
						}else if(seat == 'banned'){
							seatElement.css('background-color', 'black');
							seatElement.attr('disabled', true);
							seatElement.val(y);
						}
						seatElement.css('height', '30px');
						seatElement.css('width', '50px');
						row.append(seatElement);
					}
					seatInfo.append(row);
				} 
			}// end seat init
			
			function repaintBtn(){
				// 모든 버튼을 검사하여, 선택된 번호는 red, 선택가능한 번호는 lightgrey, 선택불가 번호는 enable
				console.log('repaintBtn');
				$('input.btnGuestNum').each(function(index, element){
					let type = this.parentElement.innerText;
					let num = parseInt(this.value);
					let expect = selectedGuestNum - guestNum[type] + num;
					if(expect > maxGuestNum){
						element.style.backgroundColor = 'black';
						element.disabled = true;
					}else if(guestNum[type] == num){
						element.style.backgroundColor = 'red';
						element.disabled = true;
					}else{
						element.style.backgroundColor = 'lightgrey';
						element.disabled = false;
					}
				}); // end each
			} // end reprintBtn
			
			$('#btnReset').click(function(){
				clear();
			});
			
			btnNext.click(function(){
				ticketing();
				clear();
				initTicket();
			});
			
			function clear(){//요금 초기화, 선택한 좌석 초기화, seatmap 재출력, guestNum 재출력
				console.log('clear()');
				selectedGuestNum = 0;
				selectedSeatNum = 0;
				
				for(x in guestType){
					guestNum[guestType[x]] = 0;
				}
				for(x in seatMap){
					for(y in seatMap[x]){
						if(seatState[seatMap[x][y]] == 'selected'){
							seatMap[x][y] = 1;
						}
					}
				}
				seatInfo.empty();
				initSeat();
				repaintBtn();
				refreshSeatShort();
				refreshGuestShort();
				chargeCheck();
			} // end clear
			
		}); // end document ready
		
		function refreshSeatShort(){
			console.log('refreshSeatShort()');
			seatShort.text(' ');
			for(x in seatMap){
				for(y in seatMap[x]){
					if(seatMap[x][y] == 2){
						seatShort.text(seatShort.text() + x + y + ' ');
					}
				}
			}
		} // end refreshSeatShort
		
		function refreshGuestShort(){
			console.log('refreshGuestShort()');
			guestShort.empty();
			let total = 0;
			let printedGuestNum = selectedSeatNum;
			
			for(x in guestNum){
				if(guestNum[x] != 0){
					let priceRow = $('<div></div>');
					
					// 손님 타입별 요금 계산 후 출력
					let n = Math.min(guestNum[x], printedGuestNum);
					priceRow.text(x + ' ' + priceMap[x] + ' X' + n);
					total += priceMap[x] * n;
					printedGuestNum = Math.max(printedGuestNum - guestNum[x], 0);
					guestShort.append(priceRow);
				}
				if(printedGuestNum == 0){
					break;
				}
			}
			let priceTotal = $('<div></div>');
			priceTotal.text('총 금액 : ' + total);
			guestShort.append(priceTotal);
			
		} // end refreshGuestShort
		
		function initTicket(){
			console.log('init ticketInfo');
			selectedSeatNum = 0;
			selectedGuestNum = 0;
			enableSeatNum = 0;
			maxSeatNum = 0;
			
			for(x in guestType){
				guestNum[guestType[x]] = 0;
			}
			
			// movieInfo init
			for(x in seatMap){ // calc
				for(y in seatMap[x]){
					if(seatState[seatMap[x][y]] != 'none'){
						maxSeatNum++;
					}
					if(seatState[seatMap[x][y]] == 'enable'){
						enableSeatNum++;
					}
				}
			}
			$('.cinemaName').text(cinemaName);
			$('.cinemaNumber').text(cinemaNumber);
			$('#remainSeat').text(enableSeatNum);
			$('#maxSeat').text(maxSeatNum);
			btnNext.css('visibility', 'hidden');
		} // end initTicket
		
		function limitCheck(typeName, selectedNum){
			// selectedNum가 추가되었을때 총 합이 maxGuestNum보다 큰 경우 false
			// selectedNum가 추가되었을때 총 합이 selectedSeatNum보다 작은 경우 false
			console.log("limitCheck");
			let expect = selectedGuestNum - guestNum[typeName] + selectedNum;
			
			if(expect > maxGuestNum){
				return false;
			}
			if(expect < selectedSeatNum){
				alert('선택한 좌석이 예매 인원 보다 많습니다.');
				return false;
			}
			return true;
		} // end limitCheck
		
		function chargeCheck(){
			console.log('chargeCheck');
			if(selectedSeatNum > 0 && selectedSeatNum == selectedGuestNum){
				btnNext.css('visibility', 'visible');
			}else{
				btnNext.css('visibility', 'hidden');
			}
		} // end chargeCheck
		
		function ticketing(){
			console.log('ticketing complete!');
			for(x in seatMap){
				for(y in seatMap[x]){
					if(seatState[seatMap[x][y]] == 'selected'){
						seatMap[x][y] = 3;
					}
				}
			}
			alert('예매 성공!!!!!!!!');
		} // end ticketing
	</script>
</body>
</html>